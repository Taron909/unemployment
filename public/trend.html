<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>趨勢分析｜台灣失業率</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" />
  <style>
    :root{ --brand-blue:#21409a; --brand-accent:#d65b29; --bg-cream:#fdfcd9; --footer-h:68px }
    *,*::before,*::after{ box-sizing:border-box }
    body{ font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg-cream); margin:0; padding-bottom:var(--footer-h); line-height:1.6 }
    .header{ background:var(--brand-blue); color:#fff; text-align:center; padding:24px 12px; font-size:clamp(1.4rem,2.5vw,2rem); font-weight:700 }
    nav{ background:var(--brand-blue); display:flex; flex-wrap:wrap; justify-content:center }
    nav a{ line-height:2em; padding:18px 26px; color:#fff; text-decoration:none; font-weight:700; white-space:nowrap; font-size:clamp(0.9em,2.5vw,1.1em) }
    nav a:hover{ background:#880e4f } nav .active{ background:#800080!important; color:#fff!important }
    main{ max-width:1200px; margin:40px auto; padding:0 20px }
    .chart-section{ display:flex; flex-wrap:wrap; gap:30px; align-items:flex-start; margin-bottom:60px; min-width:0 }
    .chart-canvas{ position:relative; flex:1 1 600px; max-width:700px; min-width:300px; height:420px; overflow:hidden }
    .chart-canvas>canvas{ position:absolute; inset:0 } .chart-description{ flex:1 1 320px; min-width:300px; max-width:800px; line-height:1.8; margin:auto }
    .chart-description h3{ color:var(--brand-blue); font-size:1.6em; margin-bottom:10px }
    .table-container{ overflow:auto; margin-top:20px; max-height:520px }
    .table-container table{ border-collapse:separate; border-spacing:0; table-layout:fixed; width:100%; background:#fffdf3; min-width:320px }
    .table-container th{ background:var(--brand-blue); color:#fff; padding:10px 12px; border:1px solid #ccc; text-align:center; font-weight:600; line-height:1.5 }
    .table-container td{ padding:10px 12px; border:1px solid #ccc; line-height:1.4; text-align:center; vertical-align:middle; word-break:break-word }
    .table-container th:nth-child(1), .table-container td:nth-child(1){ width:18% }
    .table-container th:nth-child(2), .table-container td:nth-child(2){ width:18% }
    .table-container th:nth-child(3), .table-container td:nth-child(3){ width:64% }
    .table-container{ font-size:clamp(0.65rem,1vw,0.65rem) }
    .nav-buttons{ display:flex; justify-content:center; align-items:center; margin:40px 0; gap:40px; flex-wrap:wrap }
    .nav-buttons button{ background:var(--brand-blue); color:#fff; border:none; padding:10px 20px; font-size:1em; cursor:pointer; border-radius:5px; min-width:80px }
    .nav-buttons button:hover{ background:#880e4f } .page-indicator{ font-weight:700; color:var(--brand-blue) }
    .page{ display:none } .page.active{ display:flex }
    .footer{ position:fixed; bottom:0; left:0; right:0; background:#21409a; color:#fff; text-align:center; padding:14px; font-size:.95em }
    .footer a{ color:#fff; text-decoration:underline }
    @media (max-width:768px){ nav.w3-bar{ flex-direction:column } nav.w3-bar a{ width:100%; text-align:center; padding:14px 18px } .chart-canvas{ height:auto; aspect-ratio:16/10 } .table-container table{ min-width:480px } }
    @media (max-width:640px){ .table-container table,.table-container thead,.table-container tbody,.table-container tr,.table-container th,.table-container td{ display:block; width:100% } .table-container thead{ display:none } .table-container tr{ border:1px solid #ddd; border-radius:12px; margin-bottom:12px; background:#fff; overflow:hidden } .table-container td{ border:none; padding:12px 14px; line-height:1.6; font-size:1.05em } .table-container td::before{ content:attr(data-label); display:block; font-weight:700; color:#21409a; margin-bottom:4px; font-size:0.95em } }
  </style>
</head>
<body>
  <header class="header">數據之下的現實：重新認識台灣失業率</header>
  <nav class="w3-bar w3-indigo">
    <a href="index.html" class="w3-bar-item w3-button w3-hover-white">首頁</a>
    <a href="trend.html" class="w3-bar-item w3-button w3-hover-white active" aria-current="page">趨勢分析</a>
    <a href="policy.html" class="w3-bar-item w3-button w3-hover-white">國家政策</a>
    <a href="case.html" class="w3-bar-item w3-button w3-hover-white">實際案例</a>
    <a href="chatbot.html" class="w3-bar-item w3-button w3-hover-white">智能諮詢室</a>
  </nav>
  <main>
    <section class="chart-section page active" id="page1">
      <div class="chart-canvas"><canvas id="lineChart"></canvas></div>
      <div class="chart-description">
        <h3>台灣失業總量的變動趨勢</h3>
        <p>失業率對景氣循環、產業轉型與外部衝擊高度敏感。</p>
        <p><b>公式：</b> 失業率 = 失業人數 ÷ 勞動力 × 100%</p>
        <div class="table-container">
          <table>
            <thead><tr><th>年度</th><th>失業率 (%)</th><th>重大事件或影響因素</th></tr></thead>
            <tbody id="summary-rows"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section class="chart-section page" id="page2">
      <div class="chart-canvas"><canvas id="barChart"></canvas></div>
      <div class="chart-description">
        <h3>台灣勞動市場總體結構變化</h3>
        <ul><li>企業缺工？</li><li>市場缺好工？</li><li>人才與職缺是否「對不上」？</li></ul>
      </div>
    </section>
    <section class="chart-section page" id="page3">
      <div class="chart-canvas"><canvas id="dualLineChart"></canvas></div>
      <div class="chart-description">
        <h3>參與了，卻沒被雇用？</h3>
        <p>將勞動力參與率與「就業人口占 15 歲以上人口」並列觀察投入與被雇用的落差。</p>
        <p>📌 勞動力參與率 = （在職＋失業）÷ 15 歲以上人口 × 100%</p>
      </div>
    </section>
    <div class="nav-buttons">
      <button onclick="changePage(-1)">上一頁</button>
      <div class="page-indicator">第 <span id="pageNum">1</span> / 3 頁</div>
      <button onclick="changePage(1)">下一頁</button>
    </div>
  </main>
  <footer class="footer">📩 聯絡我們 Taron_Lin｜<a href="#" onclick="openGmail()">blue8841269@gmail.com</a></footer>
  <script>
    const pages=document.querySelectorAll('.page'); let currentPage=0; let chartData=null;
    let lineChartInstance=null,barChartInstance=null,dualLineChartInstance=null;
    function toNumberArray(a){ return (a||[]).map(v=>{ if(typeof v==='number') return v; if(v==null) return NaN; const n=parseFloat(String(v).replace(/[,%\s]/g,'')); return Number.isFinite(n)?n:NaN; });}
    function toPercentString(value){ if(value==null) return ''; if(typeof value!=='number') value=parseFloat(String(value).replace(/[,%\s]/g,'')); if(!Number.isFinite(value)) return ''; const isRatio = value>0 && value<=1; const pct=isRatio?value*100:value; return pct.toFixed(1); }
    function normalizeYearLabel(label){ if(label==null) return null; const s=String(label).trim(); const m=s.match(/民國\s*([0-9]{1,3})\s*年?/); if(m){const y=parseInt(m[1],10); if(Number.isFinite(y)) return 1911+y;} const w=s.match(/([12][0-9]{3})/); if(w){const y=parseInt(w[1],10); if(Number.isFinite(y)) return y;} if(!isNaN(Number(s))){ const y=Number(s); if(Number.isInteger(y)&&y>=1900&&y<=2100) return y;} return null; }
    function buildYearIndexMap(labels){ const map=new Map(); (labels||[]).forEach((lab,i)=>{ const y=normalizeYearLabel(lab); if(y!=null&&!map.has(y)) map.set(y,i); }); return map; }
    function getRateByYear(year, map){ const idx=map.get(year); if(idx==null) return null; const arr=chartData?.line_chart_data?.datasets?.[0]?.data||[]; const raw=arr[idx]; if(raw==null) return null; const n=parseFloat(String(raw).replace(/[,%\s]/g,'')); return Number.isFinite(n)?n:null; }
    function tableRowHTML(periodText, rateValue, note){ const rate=rateValue===''?'':toPercentString(rateValue); const safeNote=(note==null||String(note).trim()==='')?'—':note; return `<tr><td data-label="年度" style="vertical-align:middle"><b>${periodText}</b></td><td data-label="失業率 (%)">${rate}</td><td data-label="重大事件或影響因素">${safeNote}</td></tr>`; }
    function renderSummaryTableFromJSON(map){ const tbody=document.getElementById('summary-rows'); if(!tbody) return false; const table=chartData?.summary_table; if(!Array.isArray(table)||table.length===0) return false; tbody.innerHTML=table.map(row=>{ const periodText=row.period ?? (row.year!=null?String(row.year):(row.start!=null&&row.end!=null?`${row.start}–${row.end}`:'—')); let rateValue=row.rate; if(rateValue==null){ const y=row.year ?? row.start ?? null; const v=y!=null?getRateByYear(y,map):null; rateValue=v??''; } return tableRowHTML(periodText, rateValue, row.note); }).join(''); return true; }
    function renderSummaryTableAuto(map){ const tbody=document.getElementById('summary-rows'); if(!tbody) return; const L=chartData?.line_chart_data?.labels||[]; if(L.length===0){ tbody.innerHTML='<tr><td colspan="3">（沒有可用的年份資料）</td></tr>'; return; } function rowForRangeFlexible(start,end,note){ const hasStart=map.has(start), hasEnd=map.has(end); if(!hasStart&&!hasEnd) return ''; const yearForRate=hasStart?start:(hasEnd?end:null); const v=yearForRate!=null?getRateByYear(yearForRate,map):null; const periodText=(start!=null&&end!=null)?`${start}–${end}`:(start ?? end ?? '—'); return tableRowHTML(periodText, v??'', note); }
      const lastLab=L[L.length-1]; const lastYear=normalizeYearLabel(lastLab); const lastVal=lastYear!=null?getRateByYear(lastYear,map):null;
      const rows=[
        rowForRangeFlexible(1997,1999,'亞洲金融風暴衝擊外銷與製造業，失業率上升。'),
        rowForRangeFlexible(2001,2002,'網路泡沫破裂、全球景氣趨緩。'),
        rowForRangeFlexible(2008,2009,'全球金融海嘯；政府推振興方案。'),
        rowForRangeFlexible(2020,2022,'COVID-19 衝擊接觸型服務業，失業率波動。'),
        (lastYear!=null?tableRowHTML(String(lastYear), lastVal??'', '疫後復甦，總體失業率回穩；隱性失業與就業品質仍受關注。'):'')
      ].filter(Boolean);
      if(rows.length===0){ const firstYear=normalizeYearLabel(L[0]); const firstVal=firstYear!=null?getRateByYear(firstYear,map):null; rows.push(tableRowHTML(String(firstYear ?? L[0]), firstVal ?? '', '起始年度樣本。'), tableRowHTML(String(lastYear ?? lastLab), lastVal ?? '', '最新年度樣本。')); }
      tbody.innerHTML=rows.join('');
    }
    function buildSummaryTableWithMap(){ const labels=chartData?.line_chart_data?.labels||[]; const map=buildYearIndexMap(labels); const ok=renderSummaryTableFromJSON(map); if(!ok) renderSummaryTableAuto(map); }
    function destroyChart(instance, id){ if(instance) instance.destroy(); const el=document.getElementById(id); if(el){ el.width=el.height=undefined; } }
    function showPage(index){ if(index!==0){ destroyChart(lineChartInstance,'lineChart'); lineChartInstance=null } if(index!==1){ destroyChart(barChartInstance,'barChart'); barChartInstance=null } if(index!==2){ destroyChart(dualLineChartInstance,'dualLineChart'); dualLineChartInstance=null } pages.forEach((p,i)=>p.classList.toggle('active', i===index)); document.getElementById('pageNum').textContent=index+1; currentPage=index; if(!chartData) return; requestAnimationFrame(()=>{ switch(index){ case 0: initLineChart(); break; case 1: initBarChart(); break; case 2: initDualLineChart(); break; } }); }
    function changePage(delta){ currentPage=(currentPage+delta+pages.length)%pages.length; showPage(currentPage); }
    function initLineChart(){ if(lineChartInstance) return; const labels=chartData.line_chart_data.labels; const series=toNumberArray(chartData.line_chart_data.datasets[0].data); const valid=series.filter(Number.isFinite); const ratioLike=valid.length ? (valid.filter(v=>v<=1).length/valid.length>0.6):false; const scaled=ratioLike?series.map(v=>v*100):series.slice(); const yMax=Math.ceil((Math.max(...scaled.filter(Number.isFinite))||10)*1.15); const yMin=Math.max(0, Math.floor((Math.min(...scaled.filter(Number.isFinite))||0)*0.9));
      lineChartInstance=new Chart(document.getElementById('lineChart'),{ type:'line', data:{ labels, datasets:[{ label:'失業率', data:scaled, borderColor:'#1a3f5f', backgroundColor:'rgba(26,63,95,0.15)', borderWidth:2, pointRadius:0, fill:true, tension:0.2 }]}, options:{ responsive:true, maintainAspectRatio:false, layout:{ padding:10 }, plugins:{ legend:{ display:false }}, scales:{ y:{ min:yMin, max:yMax, title:{ display:true, text:'失業率 (%)', font:{ size:12 }}, ticks:{ callback:v=>v+'%', font:{ size:10 }}}, x:{ title:{ display:true, text:'年份', font:{ size:12 }}, ticks:{ autoSkip:false, maxRotation:45, font:{ size:10 }}} }}); lineChartInstance.resize(); }
    function initBarChart(){ if(barChartInstance) return; const labels=chartData.bar_chart_data.labels; const emp=toNumberArray(chartData.bar_chart_data.datasets[0].data); const unemp=toNumberArray(chartData.bar_chart_data.datasets[1].data); const all=[...emp,...unemp].filter(Number.isFinite); const min=Math.min(...all), max=Math.max(...all), pad=Math.max(50, Math.round((max-min)*0.08)); const yMin=Math.max(0,min-pad), yMax=max+pad;
      barChartInstance=new Chart(document.getElementById('barChart'),{ type:'bar', data:{ labels, datasets:[ {label:'就業人數', data:emp, backgroundColor:'#114b87', stack:'s'}, {label:'失業人數', data:unemp, backgroundColor:'#f37021', stack:'s'} ]}, options:{ responsive:true, maintainAspectRatio:false, layout:{ padding:10 }, plugins:{ legend:{ position:'top', labels:{ font:{ size:12 }}}}, scales:{ x:{ stacked:true, title:{ display:true, text:'年份', font:{ size:12 }}, ticks:{ autoSkip:false, maxRotation:45, font:{ size:10 }}}, y:{ stacked:true, min:yMin, max:yMax, title:{ display:true, text:'人數（千人）', font:{ size:12 }}, ticks:{ font:{ size:10 }}} }}}); barChartInstance.resize(); }
    function initDualLineChart(){ if(dualLineChartInstance) return; const labels=chartData.dual_line_chart_data.labels; const p1=toNumberArray(chartData.dual_line_chart_data.datasets[0].data); const p2=toNumberArray(chartData.dual_line_chart_data.datasets[1].data);
      dualLineChartInstance=new Chart(document.getElementById('dualLineChart'),{ type:'line', data:{ labels, datasets:[ {label:'勞動力參與率(%)', data:p1, borderColor:'#114b87', backgroundColor:'#114b87', borderWidth:4, fill:false, tension:0.2, pointRadius:0}, {label:'就業人口占15歲以上民間人口(%)', data:p2, borderColor:'#f37021', backgroundColor:'#f37021', borderWidth:4, fill:false, tension:0.2, pointRadius:0} ]}, options:{ responsive:true, maintainAspectRatio:false, layout:{ padding:10 }, plugins:{ legend:{ position:'top', labels:{ font:{ size:12 }}}}, scales:{ y:{ suggestedMin:53, suggestedMax:62, title:{ display:true, text:'百分比 (%)', font:{ size:12 }}, ticks:{ callback:v=>v+'%', font:{ size:10 }}}, x:{ title:{ display:true, text:'年份', font:{ size:12 }}, ticks:{ autoSkip:false, maxRotation:45, font:{ size:10 }}} }}}); dualLineChartInstance.resize(); }
    function openGmail(){ const email="blue8841269@gmail.com"; const subject=encodeURIComponent("詢問：失業趨勢分析"); const body=encodeURIComponent("您好，我想了解台灣失業率資料的更多細節..."); window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${subject}&body=${body}`,'_blank'); }
    fetch("chart_data_embed.json?v="+Date.now()).then(res=>res.json()).then(data=>{ chartData=data; showPage(currentPage); buildSummaryTableWithMap(); window.addEventListener('resize', ()=>{ lineChartInstance?.resize(); barChartInstance?.resize(); dualLineChartInstance?.resize(); }); }).catch(err=>console.error("❌ 無法載入 chart_data_embed.json", err));
  </script>
</body>
</html>
