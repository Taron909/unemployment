<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>智能諮詢室</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    /* ===== 共用樣式 ===== */
    body {
      font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-color: #fdfcd9; /* 鵝黃色背景 */
      margin: 0;
      padding-bottom: 80px; /* 預留 footer 空間 */
    }

    h2 {
      color: #21409a;
      margin-top: 40px;
    }

    canvas {
      max-width: 100%;
      margin-bottom: 40px;
    }

    /* ===== 頁首樣式 ===== */
    .header {
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 30px 0;
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    /* ===== 導覽列樣式 ===== */
    nav {
      background-color: #21409a;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    nav a {
      display: inline-block;
      line-height: 2em;
      padding: 30px 50px;
      color: white;
      text-decoration: none;
      font-weight: bold;
      white-space: nowrap;
      font-size: clamp(0.9em, 2.5vw, 1.3em);
    }

    nav a:hover {
      background-color: #880e4f;
    }

    .w3-bar .active {
      background-color: #800080 !important;
      color: white !important;
    }

    @media (max-width: 992px) {
      nav.w3-bar a {
        padding: 20px 30px !important;
      }
    }

    @media (max-width: 768px) {
      nav.w3-bar {
        flex-direction: column;
      }
      nav.w3-bar a {
        width: 100%;
        text-align: center;
        padding: 16px 20px !important;
      }
    }

    /* ===== 頁尾樣式 ===== */
    .footer {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 10px 8px;
      z-index: 10;
    }

    .footer a {
      color: white;
      text-decoration: underline;
    }

    /* ===== 主內容區塊 ===== */
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .box {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .chat {
      min-height: 25vh;   /* 初始高度 */
      max-height: none;   /* 移除上限 */
      overflow: visible;  /* 交由 body 來滾動 */
      background: #f8fafc;
    }

    .chips button {
      border-radius: 9999px;
    }
  </style>
</head>
<body>
  <header class="header">數據之下的現實：重新認識台灣失業率</header>
  <nav class="w3-bar w3-indigo">
    <a class="w3-bar-item w3-button w3-hover-white" href="index.html">首頁</a>
    <a class="w3-bar-item w3-button w3-hover-white" href="trend.html">趨勢分析</a>
    <a class="w3-bar-item w3-button w3-hover-white" href="policy.html">國家政策</a>
    <a class="w3-bar-item w3-button w3-hover-white" href="case.html">實際案例</a>
    <a class="w3-bar-item w3-button w3-hover-white active" href="chatbot_frontend_only.html">智能諮詢室</a>
  </nav>

  <main>
    <div class="box">
      <div class="p-4 text-white text-center text-xl font-bold bg-gradient-to-r from-blue-500 to-purple-600">問問中心</div>

      <!-- Chips -->
      <div id="chips" class="chips flex flex-wrap gap-2 px-4 py-3 bg-white border-b">
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="最近三個月失業率趨勢？">最近三個月失業率趨勢？</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="青年失業的主要原因？">青年失業的主要原因？</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="我適合參加哪些職訓？">我適合參加哪些職訓？</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="幫我列出可申請的補助">幫我列出可申請的補助</button>
      </div>

      <!-- Chat -->
      <div id="chat" class="chat p-4 space-y-4"></div>
      <div id="loading" class="hidden flex justify-center items-center py-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        <span class="ml-2 text-gray-600">正在思考...</span>
      </div>

      <!-- Toolbar -->
      <div class="flex items-center justify-between px-4 py-2 bg-white border-t">
        <div class="flex gap-2">
          <button id="export-txt"  class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">匯出 .txt</button>
          <button id="clear"       class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">清除聊天</button>
        </div>
        <button id="abort" class="px-3 py-1 text-sm bg-rose-600 text-white rounded hover:bg-rose-700 hidden">停止生成</button>
      </div>

      <!-- Input -->
      <div class="p-4 bg-white border-t flex items-start gap-2">
        <textarea id="input" rows="1" class="flex-1 p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none h-12 overflow-hidden" placeholder="輸入你的訊息..."></textarea>
        <div class="flex flex-col items-end gap-2">
          <div id="counter" class="text-xs text-gray-500">0 / 500</div>
          <button id="send" class="px-6 py-3 bg-blue-600 text-white rounded shadow disabled:opacity-50" disabled>傳送</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    📩 寄信給我 林宸緯 <a href="mailto:blue8841269@gmail.com" class="underline">blue8841269@gmail.com</a>
  </footer>

  <script>
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    // ====== 設定（前端 Demo：把 key 寫這）=====
    const API_KEY    = 'AIzaSyBoFmlsnaABMBbn-r3w_49SzZlksRrHazA';            // ⛔ 只有示範用！
    const MODEL      = 'gemini-2.5-flash-preview-05-20';
    const API_URL    = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
    const STORAGE_KEY= 'chatHistoryV1';
    const MAX_CHARS  = 500;

    // ====== DOM ======
    const chatEl     = document.getElementById('chat');
    const inputEl    = document.getElementById('input');
    const sendBtn    = document.getElementById('send');
    const counterEl  = document.getElementById('counter');
    const loadingEl  = document.getElementById('loading');
    const abortBtn   = document.getElementById('abort');
    const chipsEl    = document.getElementById('chips');
    const exportTxt  = document.getElementById('export-txt');
    const exportJson = document.getElementById('export-json');
    const clearBtn   = document.getElementById('clear');

    let controller = null;
    let history = load() || [];
    marked.setOptions({ breaks:true, gfm:true });
    const md = (t)=> DOMPurify.sanitize(marked.parse(t||''));

    // 初始訊息 / 歷史
    if (history.length === 0) addMsg('bot','嗨！有什麼我可以幫助你的嗎？');
    else history.forEach(m=>addMsg(m.role==='user'?'user':'bot', m.parts?.[0]?.text||''));

    // Chips
    chipsEl.addEventListener('click', e=>{
      const b = e.target.closest('button[data-q]');
      if (!b) return;
      inputEl.value = b.dataset.q;
      updateCounter();
      inputEl.focus();
    });

    // 輸入/送出
    inputEl.addEventListener('input', ()=>{
      inputEl.style.height='auto';
      inputEl.style.height = inputEl.scrollHeight+'px';
      updateCounter();
    });
    inputEl.addEventListener('keydown', e=>{
      if (e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    sendBtn.addEventListener('click', send);

    // 匯出/清除/停止
    exportTxt.onclick  = ()=>exportChat('txt');
    clearBtn.onclick   = clearChat;
    abortBtn.onclick   = ()=>controller?.abort();

    function updateCounter(){
      const len = (inputEl.value||'').length;
      counterEl.textContent = `${len} / ${MAX_CHARS}`;
      counterEl.className   = `text-xs ${len>MAX_CHARS?'text-rose-600':'text-gray-500'}`;
      sendBtn.disabled = !(len>0 && len<=MAX_CHARS);
    }

    function addMsg(who, text, opts={markdown:true}){
      const row = document.createElement('div');
      row.className = `flex ${who==='user'?'justify-end':'justify-start'}`;
      const bubble = document.createElement('div');
      bubble.className = `max-w-[80%] p-3 rounded-lg shadow-sm ${who==='user'?'bg-blue-600 text-white':'bg-gray-200 text-gray-800'}`;
      bubble.innerHTML = opts.markdown ? md(text) : text;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      window.scrollTo(0,document.body.scrollHeight);
    }

    function setLoading(on){
      loadingEl.classList.toggle('hidden', !on);
      sendBtn.disabled = on;
      inputEl.disabled = on;
      abortBtn.classList.toggle('hidden', !on);
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
    function append(m){ history.push(m); save(); }

    function clearChat(){
      if (!confirm('確定清除聊天？')) return;
      history = []; save(); chatEl.innerHTML='';
      addMsg('bot','嗨！有什麼我可以幫助你的嗎？');
    }

    function exportChat(type){
      const name = `chat_${new Date().toISOString().replace(/[:.]/g,'-')}.${type}`;
      let blob;
      if (type==='json') blob = new Blob([JSON.stringify(history,null,2)],{type:'application/json'});
      else {
        const txt = history.map(m=>{
          const who = m.role==='user'?'使用者':'助理';
          return `【${who}】\n${m.parts?.[0]?.text||''}\n`;
        }).join('\n---\n');
        blob = new Blob([txt],{type:'text/plain;charset=utf-8'});
      }
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      URL.revokeObjectURL(a.href);
    }

    async function send(){
      const prompt = inputEl.value.trim();
      if (!prompt || prompt.length>MAX_CHARS) return;

      // 顯示 & 存本地
      addMsg('user', prompt, {markdown:false});
      append({role:'user', parts:[{text:prompt}]});
      inputEl.value=''; updateCounter();

      // 呼叫 API
      setLoading(true);
      controller = new AbortController();
      try{
        const res = await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ contents: history }),
          signal: controller.signal
        });
        if (!res.ok){
          let msg = `API ${res.status}`;
          if (res.status===403) msg = '403 Forbidden（Key 無效或被限制）。';
          throw new Error(msg);
        }
        const data = await res.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '（無回應內容）';
        addMsg('bot', text);
        append({role:'model', parts:[{text}]});
      }catch(err){
        console.error(err);
        addMsg('bot', '抱歉，連線發生錯誤，請稍後再試。');
      }finally{
        setLoading(false);
        controller = null;
      }
    }

    // 初始化
    updateCounter();
  </script>
</body>
</html>
