<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½è«®è©¢å®¤</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    /* ===== å…±ç”¨æ¨£å¼ ===== */
    body {
      font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-color: #fdfcd9; /* éµé»ƒè‰²èƒŒæ™¯ */
      margin: 0;
      padding-bottom: 80px; /* é ç•™ footer ç©ºé–“ */
    }

    h2 {
      color: #21409a;
      margin-top: 40px;
    }

    canvas {
      max-width: 100%;
      margin-bottom: 40px;
    }

    /* ===== é é¦–æ¨£å¼ ===== */
    .header {
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 30px 0;
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    /* ===== å°è¦½åˆ—æ¨£å¼ ===== */
    nav {
      background-color: #21409a;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    nav a {
      display: inline-block;
      line-height: 2em;
      padding: 30px 50px;
      color: white;
      text-decoration: none;
      font-weight: bold;
      white-space: nowrap;
      font-size: clamp(0.9em, 2.5vw, 1.3em);
    }

    nav a:hover {
      background-color: #880e4f;
    }

    .w3-bar .active {
      background-color: #800080 !important;
      color: white !important;
    }

    @media (max-width: 992px) {
      nav.w3-bar a {
        padding: 20px 30px !important;
      }
    }

    @media (max-width: 768px) {
      nav.w3-bar {
        flex-direction: column;
      }
      nav.w3-bar a {
        width: 100%;
        text-align: center;
        padding: 16px 20px !important;
      }
    }

    /* ===== é å°¾æ¨£å¼ ===== */
    .footer {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 10px 8px;
      z-index: 10;
    }

    .footer a {
      color: white;
      text-decoration: underline;
    }

    /* ===== ä¸»å…§å®¹å€å¡Š ===== */
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .box {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .chat {
      min-height: 25vh;   /* åˆå§‹é«˜åº¦ */
      max-height: none;   /* ç§»é™¤ä¸Šé™ */
      overflow: visible;  /* äº¤ç”± body ä¾†æ»¾å‹• */
      background: #f8fafc;
    }

    .chips button {
      border-radius: 9999px;
    }
  </style>
</head>
<body>
  <header class="header">æ•¸æ“šä¹‹ä¸‹çš„ç¾å¯¦ï¼šé‡æ–°èªè­˜å°ç£å¤±æ¥­ç‡</header>
  <nav class="w3-bar w3-indigo">
    <a class="w3-bar-item w3-button w3-hover-white" href="index.html">é¦–é </a>
    <a class="w3-bar-item w3-button w3-hover-white" href="trend.html">è¶¨å‹¢åˆ†æ</a>
    <a class="w3-bar-item w3-button w3-hover-white" href="policy.html">åœ‹å®¶æ”¿ç­–</a>
    <a class="w3-bar-item w3-button w3-hover-white" href="case.html">å¯¦éš›æ¡ˆä¾‹</a>
    <a class="w3-bar-item w3-button w3-hover-white active" href="chatbot_frontend_only.html">æ™ºèƒ½è«®è©¢å®¤</a>
  </nav>

  <main>
    <div class="box">
      <div class="p-4 text-white text-center text-xl font-bold bg-gradient-to-r from-blue-500 to-purple-600">å•å•ä¸­å¿ƒ</div>

      <!-- Chips -->
      <div id="chips" class="chips flex flex-wrap gap-2 px-4 py-3 bg-white border-b">
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="æœ€è¿‘ä¸‰å€‹æœˆå¤±æ¥­ç‡è¶¨å‹¢ï¼Ÿ">æœ€è¿‘ä¸‰å€‹æœˆå¤±æ¥­ç‡è¶¨å‹¢ï¼Ÿ</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="é’å¹´å¤±æ¥­çš„ä¸»è¦åŸå› ï¼Ÿ">é’å¹´å¤±æ¥­çš„ä¸»è¦åŸå› ï¼Ÿ</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="æˆ‘é©åˆåƒåŠ å“ªäº›è·è¨“ï¼Ÿ">æˆ‘é©åˆåƒåŠ å“ªäº›è·è¨“ï¼Ÿ</button>
        <button class="px-3 py-1 bg-blue-50 text-blue-700 hover:bg-blue-100" data-q="å¹«æˆ‘åˆ—å‡ºå¯ç”³è«‹çš„è£œåŠ©">å¹«æˆ‘åˆ—å‡ºå¯ç”³è«‹çš„è£œåŠ©</button>
      </div>

      <!-- Chat -->
      <div id="chat" class="chat p-4 space-y-4"></div>
      <div id="loading" class="hidden flex justify-center items-center py-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        <span class="ml-2 text-gray-600">æ­£åœ¨æ€è€ƒ...</span>
      </div>

      <!-- Toolbar -->
      <div class="flex items-center justify-between px-4 py-2 bg-white border-t">
        <div class="flex gap-2">
          <button id="export-txt"  class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">åŒ¯å‡º .txt</button>
          <button id="clear"       class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">æ¸…é™¤èŠå¤©</button>
        </div>
        <button id="abort" class="px-3 py-1 text-sm bg-rose-600 text-white rounded hover:bg-rose-700 hidden">åœæ­¢ç”Ÿæˆ</button>
      </div>

      <!-- Input -->
      <div class="p-4 bg-white border-t flex items-start gap-2">
        <textarea id="input" rows="1" class="flex-1 p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none h-12 overflow-hidden" placeholder="è¼¸å…¥ä½ çš„è¨Šæ¯..."></textarea>
        <div class="flex flex-col items-end gap-2">
          <div id="counter" class="text-xs text-gray-500">0 / 500</div>
          <button id="send" class="px-6 py-3 bg-blue-600 text-white rounded shadow disabled:opacity-50" disabled>å‚³é€</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    ğŸ“© å¯„ä¿¡çµ¦æˆ‘ æ—å®¸ç·¯ <a href="mailto:blue8841269@gmail.com" class="underline">blue8841269@gmail.com</a>
  </footer>

  <script>
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    // ====== è¨­å®šï¼ˆå‰ç«¯ Demoï¼šæŠŠ key å¯«é€™ï¼‰=====
    const API_KEY    = 'AIzaSyBoFmlsnaABMBbn-r3w_49SzZlksRrHazA';            // â›” åªæœ‰ç¤ºç¯„ç”¨ï¼
    const MODEL      = 'gemini-2.5-flash-preview-05-20';
    const API_URL    = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
    const STORAGE_KEY= 'chatHistoryV1';
    const MAX_CHARS  = 500;

    // ====== DOM ======
    const chatEl     = document.getElementById('chat');
    const inputEl    = document.getElementById('input');
    const sendBtn    = document.getElementById('send');
    const counterEl  = document.getElementById('counter');
    const loadingEl  = document.getElementById('loading');
    const abortBtn   = document.getElementById('abort');
    const chipsEl    = document.getElementById('chips');
    const exportTxt  = document.getElementById('export-txt');
    const exportJson = document.getElementById('export-json');
    const clearBtn   = document.getElementById('clear');

    let controller = null;
    let history = load() || [];
    marked.setOptions({ breaks:true, gfm:true });
    const md = (t)=> DOMPurify.sanitize(marked.parse(t||''));

    // åˆå§‹è¨Šæ¯ / æ­·å²
    if (history.length === 0) addMsg('bot','å—¨ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ');
    else history.forEach(m=>addMsg(m.role==='user'?'user':'bot', m.parts?.[0]?.text||''));

    // Chips
    chipsEl.addEventListener('click', e=>{
      const b = e.target.closest('button[data-q]');
      if (!b) return;
      inputEl.value = b.dataset.q;
      updateCounter();
      inputEl.focus();
    });

    // è¼¸å…¥/é€å‡º
    inputEl.addEventListener('input', ()=>{
      inputEl.style.height='auto';
      inputEl.style.height = inputEl.scrollHeight+'px';
      updateCounter();
    });
    inputEl.addEventListener('keydown', e=>{
      if (e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    sendBtn.addEventListener('click', send);

    // åŒ¯å‡º/æ¸…é™¤/åœæ­¢
    exportTxt.onclick  = ()=>exportChat('txt');
    clearBtn.onclick   = clearChat;
    abortBtn.onclick   = ()=>controller?.abort();

    function updateCounter(){
      const len = (inputEl.value||'').length;
      counterEl.textContent = `${len} / ${MAX_CHARS}`;
      counterEl.className   = `text-xs ${len>MAX_CHARS?'text-rose-600':'text-gray-500'}`;
      sendBtn.disabled = !(len>0 && len<=MAX_CHARS);
    }

    function addMsg(who, text, opts={markdown:true}){
      const row = document.createElement('div');
      row.className = `flex ${who==='user'?'justify-end':'justify-start'}`;
      const bubble = document.createElement('div');
      bubble.className = `max-w-[80%] p-3 rounded-lg shadow-sm ${who==='user'?'bg-blue-600 text-white':'bg-gray-200 text-gray-800'}`;
      bubble.innerHTML = opts.markdown ? md(text) : text;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      window.scrollTo(0,document.body.scrollHeight);
    }

    function setLoading(on){
      loadingEl.classList.toggle('hidden', !on);
      sendBtn.disabled = on;
      inputEl.disabled = on;
      abortBtn.classList.toggle('hidden', !on);
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
    function append(m){ history.push(m); save(); }

    function clearChat(){
      if (!confirm('ç¢ºå®šæ¸…é™¤èŠå¤©ï¼Ÿ')) return;
      history = []; save(); chatEl.innerHTML='';
      addMsg('bot','å—¨ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ');
    }

    function exportChat(type){
      const name = `chat_${new Date().toISOString().replace(/[:.]/g,'-')}.${type}`;
      let blob;
      if (type==='json') blob = new Blob([JSON.stringify(history,null,2)],{type:'application/json'});
      else {
        const txt = history.map(m=>{
          const who = m.role==='user'?'ä½¿ç”¨è€…':'åŠ©ç†';
          return `ã€${who}ã€‘\n${m.parts?.[0]?.text||''}\n`;
        }).join('\n---\n');
        blob = new Blob([txt],{type:'text/plain;charset=utf-8'});
      }
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      URL.revokeObjectURL(a.href);
    }

    async function send(){
      const prompt = inputEl.value.trim();
      if (!prompt || prompt.length>MAX_CHARS) return;

      // é¡¯ç¤º & å­˜æœ¬åœ°
      addMsg('user', prompt, {markdown:false});
      append({role:'user', parts:[{text:prompt}]});
      inputEl.value=''; updateCounter();

      // å‘¼å« API
      setLoading(true);
      controller = new AbortController();
      try{
        const res = await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ contents: history }),
          signal: controller.signal
        });
        if (!res.ok){
          let msg = `API ${res.status}`;
          if (res.status===403) msg = '403 Forbiddenï¼ˆKey ç„¡æ•ˆæˆ–è¢«é™åˆ¶ï¼‰ã€‚';
          throw new Error(msg);
        }
        const data = await res.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ï¼ˆç„¡å›æ‡‰å…§å®¹ï¼‰';
        addMsg('bot', text);
        append({role:'model', parts:[{text}]});
      }catch(err){
        console.error(err);
        addMsg('bot', 'æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }finally{
        setLoading(false);
        controller = null;
      }
    }

    // åˆå§‹åŒ–
    updateCounter();
  </script>
</body>
</html>
