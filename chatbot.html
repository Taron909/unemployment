<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <!-- viewport meta æ¨™ç±¤æ˜¯éŸ¿æ‡‰å¼è¨­è¨ˆçš„åŸºç¤ï¼Œå®ƒå‘Šè¨´ç€è¦½å™¨é é¢æ‡‰å¦‚ä½•ç¸®æ”¾ä»¥é©æ‡‰è¨­å‚™å¯¬åº¦ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½è«®è©¢å®¤ï½œæ•¸æ“šä¹‹ä¸‹çš„ç¾å¯¦ï¼šé‡æ–°èªè­˜å°ç£å¤±æ¥­ç‡</title>
  <!-- å¼•å…¥ W3.CSS æ¨£å¼åº«ï¼Œç”¨æ–¼å°è¦½åˆ—å’Œé€šç”¨æ’ç‰ˆ -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <!-- å¼•å…¥ Google Fonts çš„æ€æºé»‘é«”ï¼Œä½œç‚ºä¸»è¦å­—é«” -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC">
  <!-- å¼•å…¥ Tailwind CSS CDNï¼Œç”¨æ–¼å¿«é€Ÿé€ å‹ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown è½‰æ› + å®‰å…¨æ·¨åŒ– -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

  <style>
    /* é€šç”¨æ¨£å¼è¨­å®š */
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #fdfcd9;
      margin: 0;
      padding: 0;
    }
    h2 {
      color: #21409a;
      margin-top: 40px;
    }
    canvas { max-width: 100%; margin-bottom: 40px; }

    /* é é¦– */
    .header {
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 30px 0;
      font-size: 2em;
      font-weight: bold;
    }

    /* å°è¦½åˆ—ï¼ˆç¶­æŒåŸé…è‰²èˆ‡çµæ§‹ï¼‰ */
    nav {
      background-color: #21409a;
      display: flex; flex-wrap: wrap; justify-content: center;
    }
    nav a {
      display: inline-block;
      line-height: 2em;
      padding: 30px 50px;
      color: white; text-decoration: none; font-weight: bold;
      white-space: nowrap;
      font-size: clamp(0.9em, 2.5vw, 1.3em);
    }
    nav a:hover { background-color: #880e4f; }
    .w3-bar .active { background-color: #800080 !important; color: white !important; }

    /* é å°¾å›ºå®šåœ¨åº•éƒ¨ */
    .footer {
      background-color: #21409a;
      color: white;
      text-align: center;
      padding: 16px;
      font-size: 0.95em;
      position: fixed; bottom: 0; left: 0; width: 100%;
      z-index: 10; line-height: 1.4;
    }
    .footer a { color: white; text-decoration: underline; }

    /* ä¸»å…§å®¹é¿å…è¢« footer è“‹ä½ */
    main {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px 100px 20px; /* åº•éƒ¨ç•™ç™½ */
    }

    /* å…§åµŒèŠå¤©å®¹å™¨ */
    .inline-chat-container {
      margin: 40px auto; width: 100%; max-width: 800px; min-height: 800px; /* èª¿æ•´èŠå¤©å®¹å™¨çš„æœ€å°é«˜åº¦ */
      display: flex; flex-direction: column;
      background-color: white; border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }

    /* è‡ªè¨‚æ»¾å‹•æ¢ï¼ˆæ•´ç«™é©ç”¨ï¼‰ */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* èŠå¤©è¨Šæ¯å€å¡Š */
    .chat-messages {
      overflow-y: auto;
      padding: 1.5rem;
      background-color: #f8fafc;
      flex-grow: 1; /* è®“å°è©±æ¡†å¡«æ»¿å¯ç”¨ç©ºé–“ */
    }

    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 480px) {
      .inline-chat-container { width: 90%; }
      main { padding: 20px 10px 100px 10px; }
    }
    @media screen and (max-width: 768px) {
      nav { flex-direction: column; }
      nav a { padding: 15px 20px; }
    }
  </style>
</head>

<body class="gemini-chat-body">
  <header class="header">æ•¸æ“šä¹‹ä¸‹çš„ç¾å¯¦ï¼šé‡æ–°èªè­˜å°ç£å¤±æ¥­ç‡</header>

  <!-- å°è¦½åˆ— -->
  <nav class="w3-bar w3-indigo">
    <div class="nav-wrapper" style="display: flex; justify-content: center; gap: 0px;">
      <a href="index.html"    class="w3-bar-item w3-button w3-hover-white">é¦–é </a>
      <a href="trend.html"    class="w3-bar-item w3-button w3-hover-white">è¶¨å‹¢åˆ†æ</a>
      <a href="policy.html"   class="w3-bar-item w3-button w3-hover-white">åœ‹å®¶æ”¿ç­–</a>
      <a href="case.html"     class="w3-bar-item w3-button w3-hover-white">å¯¦éš›æ¡ˆä¾‹</a>
      <a href="chatbot.html" class="w3-bar-item w3-button w3-hover-white active">æ™ºèƒ½è«®è©¢å®¤</a>
    </div>
  </nav>

  <main>
    <!-- èŠå¤©å®¹å™¨ -->
    <div id="inline-chat-container" class="inline-chat-container">
      <!-- æ¨™é¡Œ -->
      <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-center text-2xl font-bold rounded-t-xl shadow-md">
        å•å•ä¸­å¿ƒ
      </div>

      <!-- å¸¸ç”¨æå• Chips -->
      <div id="chips" class="flex flex-wrap gap-2 px-4 py-3 border-b border-gray-200 bg-white">
        <button class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm hover:bg-blue-100" data-q="æœ€è¿‘ä¸‰å€‹æœˆå¤±æ¥­ç‡è¶¨å‹¢ï¼Ÿ">æœ€è¿‘ä¸‰å€‹æœˆå¤±æ¥­ç‡è¶¨å‹¢ï¼Ÿ</button>
        <button class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm hover:bg-blue-100" data-q="é’å¹´å¤±æ¥­çš„ä¸»è¦åŸå› ï¼Ÿ">é’å¹´å¤±æ¥­çš„ä¸»è¦åŸå› ï¼Ÿ</button>
        <button class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm hover:bg-blue-100" data-q="æˆ‘é©åˆåƒåŠ å“ªäº›è·è¨“ï¼Ÿ">æˆ‘é©åˆåƒåŠ å“ªäº›è·è¨“ï¼Ÿ</button>
        <button class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm hover:bg-blue-100" data-q="å¹«æˆ‘åˆ—å‡ºå¯ç”³è«‹çš„è£œåŠ©">å¹«æˆ‘åˆ—å‡ºå¯ç”³è«‹çš„è£œåŠ©</button>
      </div>

      <!-- è¨Šæ¯é¡¯ç¤º -->
      <div id="chat-messages" class="chat-messages">
        <!-- åˆå§‹å•å€™èªç¾åœ¨å®Œå…¨ç”± JavaScript å‹•æ…‹æ–°å¢ï¼Œé¿å…é‡è¤‡ -->
      </div>

      <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
      <div id="loading-indicator" class="hidden flex justify-center items-center py-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        <span class="ml-2 text-gray-600">æ­£åœ¨æ€è€ƒ...</span>
      </div>

      <!-- å·¥å…·åˆ—ï¼šåŒ¯å‡º / æ¸…é™¤ / åœæ­¢ -->
      <div class="flex items-center justify-between px-4 py-2 bg-white border-t border-gray-200">
        <div class="flex gap-2">
          <button id="export-txt"  class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">åŒ¯å‡º .txt</button>
          <button id="export-json" class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">åŒ¯å‡º .json</button>
          <button id="clear-chat"  class="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200">æ¸…é™¤èŠå¤©</button>
        </div>
        <button id="abort-btn" class="px-3 py-1 text-sm bg-rose-600 text-white rounded hover:bg-rose-700 hidden">åœæ­¢ç”Ÿæˆ</button>
      </div>

      <!-- è¼¸å…¥åˆ—ï¼ˆå«å­—æ•¸è¨ˆæ•¸å™¨ï¼‰ -->
      <div class="p-4 border-t border-gray-200 flex items-start gap-2 bg-white rounded-b-xl">
        <textarea
          id="user-input"
          class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none h-12 overflow-hidden transition-all duration-200"
          placeholder="è¼¸å…¥ä½ çš„è¨Šæ¯..."
          rows="1"
        ></textarea>
        <div class="flex flex-col items-end gap-2">
          <div id="char-counter" class="text-xs text-gray-500">0 / 500</div>
          <button
            id="send-button"
            class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors duration-200 disabled:opacity-50"
            disabled
          >å‚³é€</button>
        </div>
      </div>
    </div>
  </main>

  <!-- é å°¾ -->
  <footer class="footer">
    ğŸ“© å¯„ä¿¡çµ¦æˆ‘ æ—å®¸ç·¯
    <a href="#" onclick="openGmail()">blue8841269@gmail.com</a>
  </footer>

  <script>
    /** é–‹å•Ÿ Gmail æ’°å¯«æ–°éƒµä»¶è¦–çª— */
    function openGmail() {
      const email = "blue8841269@gmail.com";
      const subject = encodeURIComponent("ä¸»æ—¨é è¨­æ–‡å­—");
      const body = encodeURIComponent("æ‚¨å¥½ï¼Œæˆ‘æƒ³äº†è§£æœ‰é—œå°ç£å¤±æ¥­ç‡è³‡æ–™çš„æ›´å¤šç´°ç¯€...");
      const gmailURL = `https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${subject}&body=${body}`;
      window.open(gmailURL, '_blank');
    }
  </script>

  <!-- æ ¸å¿ƒèŠå¤©è…³æœ¬ï¼ˆå«ï¼šChips/localStorage/Markdown/Abort/åŒ¯å‡º/å­—æ•¸ä¸Šé™ï¼‰ -->
  <script type="module">
    // ===== DOM å…ƒç´ åƒè€ƒ =====
    const chatMessages    = document.getElementById('chat-messages');
    const userInput       = document.getElementById('user-input');
    const sendButton      = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const chipsBar        = document.getElementById('chips');
    const exportTxtBtn    = document.getElementById('export-txt');
    const exportJsonBtn   = document.getElementById('export-json');
    const clearBtn        = document.getElementById('clear-chat');
    const abortBtn        = document.getElementById('abort-btn');
    const charCounter     = document.getElementById('char-counter');

    // ===== è¨­å®š =====
    const MAX_CHARS = 500;              // å­—æ•¸ä¸Šé™
    const STORAGE_KEY = 'chatHistoryV1'; // localStorage Key
    const MODEL_NAME = 'gemini-2.5-flash-preview-05-20'; // ä½¿ç”¨çš„ Gemini æ¨¡å‹åç¨±
    const MAX_RETRIES = 5; // API å‘¼å«çš„æœ€å¤§é‡è©¦æ¬¡æ•¸

    // ===== ç‹€æ…‹ç®¡ç† =====
    let chatHistory = loadHistory();
    let controller = null;    // ç”¨æ–¼ä¸­æ­¢ API è«‹æ±‚çš„ AbortController

    // ===== Markdown è¨­å®šï¼ˆå®‰å…¨æ¸²æŸ“ï¼‰======
    marked.setOptions({ breaks: true, gfm: true });
    // ä½¿ç”¨ DOMPurify æ¸…ç† Markdown å…§å®¹ä»¥é˜²æ­¢ XSS æ”»æ“Š
    const renderMarkdown = (md) => DOMPurify.sanitize(marked.parse(md ?? ''));

    // ===== åˆå§‹åŒ–ï¼šè¼‰å…¥æ­·å²è¨Šæ¯åˆ°ç•«é¢ =====
    // åªæœ‰åœ¨èŠå¤©æ­·å²ç‚ºç©ºæ™‚æ‰æ–°å¢åˆå§‹å•å€™èª
    if (chatHistory.length === 0) {
      addMessage('gemini', 'å—¨ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ');
    } else {
      chatHistory.forEach(m => addMessage(m.role === 'user' ? 'user' : 'gemini', m.parts?.[0]?.text || ''));
    }

    // ===== Chips å¿«é€Ÿæå•äº‹ä»¶ç›£è½ =====
    if (chipsBar) {
      chipsBar.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-q]');
        if (!btn) return;
        userInput.value = btn.dataset.q || '';
        updateCounter();
        userInput.focus();
      });
    }

    // ===== å‚³é€è¨Šæ¯äº‹ä»¶ç›£è½ =====
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
      // æŒ‰ä¸‹ Enter éµä¸”æœªæŒ‰ä½ Shift éµæ™‚å‚³é€è¨Šæ¯
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // é˜»æ­¢æ›è¡Œ
        sendMessage();
      }
    });

    // ===== è¼¸å…¥æ¡†è‡ªå‹•ä¼¸ç¸®èˆ‡å­—æ•¸è¨ˆæ•¸å™¨æ›´æ–° =====
    userInput.addEventListener('input', () => {
      userInput.style.height = 'auto'; // å…ˆå°‡é«˜åº¦è¨­ç‚º autoï¼Œä»¥ä¾¿æ­£ç¢ºè¨ˆç®— scrollHeight
      userInput.style.height = userInput.scrollHeight + 'px'; // è¨­ç½®ç‚ºæ»¾å‹•é«˜åº¦
      updateCounter(); // æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨
    });
    updateCounter(); // åˆå§‹åŒ–æ™‚æ›´æ–°è¨ˆæ•¸å™¨

    // ===== å·¥å…·åˆ—æŒ‰éˆ•äº‹ä»¶ç›£è½ï¼ˆåŒ¯å‡º/æ¸…é™¤/åœæ­¢ï¼‰=====
    exportTxtBtn?.addEventListener('click', () => exportChat('txt'));
    exportJsonBtn?.addEventListener('click', () => exportChat('json'));
    clearBtn?.addEventListener('click', clearChat);
    abortBtn?.addEventListener('click', abortGeneration);

    // ===== é€å‡ºè¨Šæ¯çš„æ ¸å¿ƒé‚è¼¯ =====
    async function sendMessage() {
      const prompt = userInput.value.trim();
      if (!prompt || prompt.length > MAX_CHARS) return; // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æœ‰æ•ˆ

      // å°‡ä½¿ç”¨è€…è¨Šæ¯åŠ å…¥èŠå¤©æ­·å²ä¸¦é¡¯ç¤ºåœ¨ä»‹é¢
      appendHistory({ role: 'user', parts: [{ text: prompt }] });
      addMessage('user', prompt);

      userInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
      updateCounter(); // æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨
      setLoading(true); // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨

      controller = new AbortController(); // åˆå§‹åŒ– AbortController

      const apiKey = ""; // API é‡‘é‘°ï¼Œç”± Canvas ç’°å¢ƒè‡ªå‹•æä¾›
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

      let attempt = 0;
      let success = false;
      let resultText = 'ï¼ˆç„¡å›æ‡‰å…§å®¹ï¼‰';

      // å¯¦ç¾æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
      while (attempt < MAX_RETRIES && !success) {
          try {
              const res = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: chatHistory }), // è«‹æ±‚ä¸»é«”åªåŒ…å«èŠå¤©æ­·å²
                  signal: controller.signal // å°‡ AbortController çš„ä¿¡è™Ÿå‚³éçµ¦ fetch
              });

              if (!res.ok) {
                  if (res.status === 429) { // HTTP 429: Too Many Requests
                      const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000; // æŒ‡æ•¸é€€é¿ + éš¨æ©ŸæŠ–å‹•
                      await new Promise(resolve => setTimeout(resolve, delay));
                      attempt++;
                      continue; // é€²è¡Œä¸‹ä¸€æ¬¡é‡è©¦
                  }
                  throw new Error(`API ${res.status} ${res.statusText}`); // å…¶ä»–éŒ¯èª¤ç›´æ¥æ‹‹å‡º
              }

              const result = await res.json(); // è§£æ JSON å›æ‡‰
              // å¾ Gemini API å›æ‡‰ä¸­æå–æ–‡æœ¬å…§å®¹
              if (result.candidates && result.candidates.length > 0 &&
                  result.candidates[0].content && result.candidates[0].content.parts &&
                  result.candidates[0].content.parts.length > 0) {
                  resultText = result.candidates[0].content.parts[0].text;
                  success = true; // æˆåŠŸç²å–å…§å®¹ï¼Œè·³å‡ºé‡è©¦è¿´åœˆ
              } else {
                  resultText = 'ï¼ˆAPI å›æ‡‰æ ¼å¼ä¸ç¬¦é æœŸæˆ–ç„¡å…§å®¹ï¼‰';
                  success = true; // å³ä½¿ç„¡å…§å®¹ä¹Ÿè¦–ç‚ºæˆåŠŸè™•ç†
              }
          } catch (err) {
              if (err.name === 'AbortError') {
                  resultText = 'âš ï¸ å·²åœæ­¢ç”Ÿæˆã€‚';
                  success = true; // è«‹æ±‚è¢«ä¸­æ­¢ï¼Œè·³å‡ºé‡è©¦è¿´åœˆ
                  break;
              } else {
                  console.error("API å‘¼å«éŒ¯èª¤:", err);
                  if (attempt < MAX_RETRIES - 1) {
                      const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                      await new Promise(resolve => setTimeout(resolve, delay));
                      attempt++;
                  } else {
                      resultText = 'æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'; // é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸
                      success = true;
                  }
              }
          }
      }
      // å°‡ Gemini æ¨¡å‹çš„å›æ‡‰é¡¯ç¤ºåœ¨ä»‹é¢
      addMessage('gemini', resultText, { markdown: true });

      setLoading(false); // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
      controller = null; // é‡ç½® AbortController
    }

    // ===== UI è¼”åŠ©å‡½å¼ =====
    /**
     * å°‡è¨Šæ¯åŠ å…¥èŠå¤©é¡¯ç¤ºå€
     * @param {string} sender - å‚³é€è€… ('user' æˆ– 'gemini')
     * @param {string} text - è¨Šæ¯æ–‡æœ¬
     * @param {object} opts - é¸é …ï¼Œä¾‹å¦‚ { markdown: true } æ˜¯å¦æ¸²æŸ“ç‚º Markdown
     */
    function addMessage(sender, text, opts = { markdown: false }) {
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = `p-3 rounded-lg shadow-sm max-w-[80%] ${
        sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'
      }`;

      if (opts.markdown) {
        bubble.innerHTML = renderMarkdown(text);
        // å° Markdown æ¸²æŸ“å¾Œçš„ <pre> æ¨™ç±¤é€²è¡Œæ¨£å¼èª¿æ•´
        bubble.querySelectorAll('pre').forEach(pre => {
          pre.style.overflow = 'auto';
          pre.style.padding = '8px';
          pre.style.borderRadius = '6px';
          pre.style.background = 'rgba(0,0,0,0.05)';
        });
      } else {
        bubble.textContent = text;
      }

      wrapper.appendChild(bubble);
      chatMessages.appendChild(wrapper);
      // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯
      chatMessages.scrollTop = chatMessages.scrollHeight;
      window.scrollTo(0, document.body.scrollHeight);
    }

    /**
     * é¡¯ç¤ºæˆ–éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œä¸¦æ§åˆ¶æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹
     * @param {boolean} loading - æ˜¯å¦é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
     */
    function setLoading(loading) {
      loading ? loadingIndicator.classList.remove('hidden') : loadingIndicator.classList.add('hidden');
      sendButton.disabled = loading;
      userInput.disabled  = loading;
      abortBtn.classList.toggle('hidden', !loading); // è¼‰å…¥æ™‚é¡¯ç¤ºåœæ­¢æŒ‰éˆ•
    }

    /** æ›´æ–°è¼¸å…¥æ¡†çš„å­—æ•¸è¨ˆæ•¸å’Œå‚³é€æŒ‰éˆ•ç‹€æ…‹ */
    function updateCounter() {
      const len = (userInput.value || '').length;
      const ok = len > 0 && len <= MAX_CHARS;
      charCounter.textContent = `${len} / ${MAX_CHARS}`;
      // è¶…éå­—æ•¸ä¸Šé™æ™‚é¡¯ç¤ºç´…è‰²è­¦å‘Š
      charCounter.className = `text-xs ${len > MAX_CHARS ? 'text-rose-600' : 'text-gray-500'}`;
      sendButton.disabled = !ok; // ç„¡æ•ˆè¼¸å…¥æ™‚ç¦ç”¨å‚³é€æŒ‰éˆ•
    }

    // ===== localStorage ç›¸é—œå‡½å¼ =====
    /** å¾ localStorage è¼‰å…¥èŠå¤©æ­·å² */
    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; } // è¼‰å…¥å¤±æ•—æ™‚è¿”å›ç©ºé™£åˆ—
    }

    /** å°‡ç•¶å‰èŠå¤©æ­·å²å„²å­˜åˆ° localStorage */
    function saveHistory() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
    }

    /** å°‡æ–°è¨Šæ¯åŠ å…¥èŠå¤©æ­·å²ä¸¦å„²å­˜ */
    function appendHistory(msg) {
      chatHistory.push(msg);
      saveHistory();
    }

    /** æ¸…é™¤èŠå¤©æ­·å² */
    function clearChat() {
      // é¡¯ç¤ºç¢ºèªå°è©±æ¡†ï¼Œé¿å…èª¤è§¸
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤é€™æ¬¡èŠå¤©å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      chatHistory = []; // æ¸…ç©ºæ­·å²
      saveHistory(); // æ›´æ–° localStorage
      chatMessages.innerHTML = ''; // æ¸…ç©ºé¡¯ç¤ºå€
      addMessage('gemini', 'å—¨ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ'); // é¡¯ç¤ºåˆå§‹å•å€™èª
    }

    // ===== åŒ¯å‡ºèŠå¤©è¨˜éŒ„ =====
    /**
     * åŒ¯å‡ºèŠå¤©è¨˜éŒ„ç‚º .txt æˆ– .json æª”æ¡ˆ
     * @param {string} type - åŒ¯å‡ºæª”æ¡ˆé¡å‹ ('txt' æˆ– 'json')
     */
    function exportChat(type) {
      const fileName = `chat_${new Date().toISOString().replace(/[:.]/g,'-')}.${type}`;
      let blob;
      if (type === 'json') {
        blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
      } else {
        // å°‡èŠå¤©æ­·å²è½‰æ›ç‚ºç´”æ–‡å­—æ ¼å¼
        const plain = chatHistory.map(m => {
          const who = m.role === 'user' ? 'ä½¿ç”¨è€…' : 'åŠ©ç†';
          return `ã€${who}ã€‘\n${m.parts?.[0]?.text || ''}\n`;
        }).join('\n---\n');
        blob = new Blob([plain], { type: 'text/plain;charset=utf-8' });
      }
      // å‰µå»ºä¸€å€‹éš±è—çš„ä¸‹è¼‰é€£çµä¸¦è§¸ç™¼é»æ“Š
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(a.href); // é‡‹æ”¾ URL ç‰©ä»¶
    }

    // ===== åœæ­¢ç”Ÿæˆè¨Šæ¯ =====
    function abortGeneration() {
      if (controller) controller.abort(); // è§¸ç™¼ AbortController çš„ abort() æ–¹æ³•
    }
  </script>
</body>
</html>
