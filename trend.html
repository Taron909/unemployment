<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>趨勢分析｜台灣失業率</title>

  <!-- Chart.js 使用 defer 避免阻塞 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- W3.CSS + 字體 -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" />

  <style>
      :root {
        --brand-blue: #21409a;
        --brand-ink:  #133955;
        --brand-accent: #d65b29;
        --bg-cream: #fdfcd9;
        --footer-h: 68px; /* body padding-bottom 用 */
      }
  
      *, *::before, *::after { box-sizing: border-box; }
      html,body{height:100%}
       body {
         font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
         background-color: #fdfcd9;
         margin: 0;
         padding-bottom: 80px;   /* 預留 footer 空間 */
         min-height:100vh;	                   
         
       }
  
      h2 { color: var(--brand-accent); margin-top:40px; }
  
      /* ===== 頁首 ===== */
      .header{
        background-color: var(--brand-blue);
        color:#fff;
        text-align:center;
        padding:24px 12px;
        font-size:clamp(1.4rem,2.5vw,2rem);
        font-weight:700;
      }
  
      /* 導覽列 */
      nav {
        background-color: var(--brand-blue);
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      nav a {
        line-height: 2em;
        padding: 30px 50px;
        color: white;
        text-decoration: none;
        font-weight: bold;
        white-space: nowrap;
        font-size: clamp(0.9em, 2.5vw, 1.3em);
      }
      nav a:hover { background-color: #880e4f; }
      .w3-bar .active { background-color: #800080 !important; color: #fff !important; }
  
      /* 主要容器 */
      main { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
  
      .chart-section {
        display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-start; margin-bottom: 20px; min-width: 0;
      }
      .chart-canvas {
        position: relative; flex: 1 1 600px; max-width: 700px; min-width: 300px; height: 420px; overflow: hidden;
      }
      .chart-canvas > canvas { position: absolute; inset: 0; }
      .chart-description { flex: 1 1 320px; min-width: 300px; max-width: 800px; line-height: 1.8; margin: auto; }
      .chart-description h3 { color: var(--brand-blue); font-size: 1.6em; margin-bottom: 10px; }
      .chart-description p, .chart-description li { font-size: 1.08em; }
  
      /* 表格（桌機視圖） */
      .table-container { overflow: auto; margin-top: 20px; max-height: 520px; }
      .table-container table {
        border-collapse: separate; border-spacing: 0; table-layout: fixed; width: 100%;
        background: #fffdf3; min-width: 320px;
      }
      .table-container th {
        background: var(--brand-blue); color: #fff; padding: 10px 12px;
        border: 1px solid #ccc; text-align: center; font-weight: 600; line-height: 1.5;
      }
      .table-container td {
        padding: 10px 12px; border: 1px solid #ccc; vertical-align: top; line-height: 1.4; text-align: center;
        white-space: normal; word-break: break-word; overflow-wrap: anywhere; hyphens: auto;
      }
      .table-container td b { color: #880e4f; }
      .table-container th:nth-child(1), .table-container td:nth-child(1) { width: 18%; } 
      .table-container th:nth-child(2), .table-container td:nth-child(2) { width: 18%; }
      .table-container th:nth-child(3), .table-container td:nth-child(3) { width: 64%; }
      .table-container { font-size: clamp(0.65rem, 1vw, 0.65rem); }
  
      /* 頁碼導覽 */
      .nav-buttons { display: flex; justify-content: center; align-items: center; margin: 12px 0 0;; gap: 40px; flex-wrap: wrap; }
      .nav-buttons button {
        background: var(--brand-blue); color: #fff; border: none; padding: 10px 20px; font-size: 1em;
        cursor: pointer; border-radius: 5px; min-width: 80px;
      }
      .nav-buttons button:hover { background: #880e4f; }
      .page-indicator { font-weight: 700; color: var(--brand-blue); }
  
      .page { display: none; }
      .page.active { display: flex; }
  
      /* Footer（統一版本） */
      .footer {
        background: var(--brand-blue);
        color: #fff;
        text-align: center;
        padding: 16px;
        font-size: .95em;
        position: fixed; bottom: 0; left: 0; width: 100%;
        z-index: 10; line-height: 1.4;
      }
      .footer a { color: #fff; text-decoration: underline; }
  
      /* 響應式 */
      @media (max-width: 992px) { nav.w3-bar a { padding: 14px 18px !important; } }
      @media (max-width: 768px){
        nav.w3-bar { flex-direction: column; }
        nav.w3-bar a { width: 100%; text-align: center; padding: 14px 18px; line-height: 1.6; }
        .chart-canvas { height: auto; aspect-ratio: 16/10; }
        .table-container table { min-width: 480px; }
      }
  
      /* 手機也維持表格式（用水平捲動，不改成卡片） */
@media (max-width: 640px) {
  .table-container { 
    overflow-x: auto;            /* 允許左右滑動 */
    -webkit-overflow-scrolling: touch;
  }
  .table-container table { 
    width: auto; 
    min-width: 560px;            /* 讓小螢幕出現水平卷軸 */
    table-layout: fixed;
  }
  /* 維持表格語意，不轉成 block/card */
  .table-container thead { display: table-header-group; }
  .table-container tbody { display: table-row-group; }
  .table-container tr    { display: table-row; }
  .table-container th,
  .table-container td    { display: table-cell; }
  .table-container td::before { content: none !important; }
}

  
      /* 可見鍵盤焦點（A11y） */
      a:focus-visible, button:focus-visible {
        outline: 3px solid #ffcc33; outline-offset: 2px; border-radius: 4px;
      }
      /* 減少動畫偏好 */
      @media (prefers-reduced-motion: reduce){
        *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
      }
    </style>
</head>

<body>
  <header class="header">數據之下的現實：重新認識台灣失業率</header>

  <nav class="w3-bar w3-indigo">
    <a href="index.html"  class="w3-bar-item w3-button w3-hover-white">首頁</a>
    <a href="trend.html"  class="w3-bar-item w3-button w3-hover-white active" aria-current="page">趨勢分析</a>
    <a href="policy.html" class="w3-bar-item w3-button w3-hover-white">國家政策</a>
    <a href="case.html"   class="w3-bar-item w3-button w3-hover-white">實際案例</a>
    <a href="chatbot.html" class="w3-bar-item w3-button w3-hover-white">智能諮詢室</a>
      </nav>

  <main>
    <!-- 第一頁：折線圖 + 自動表格 -->
    <section class="chart-section page active" id="page1">
      <div class="chart-canvas">
        <canvas id="lineChart"></canvas>
      </div>
      <div class="chart-description">
        <h3>台灣失業總量的變動趨勢</h3>
        <p>失業率對景氣循環、產業轉型與外部衝擊（如金融風暴、疫情）高度敏感。</p>
        <p><b>基礎公式：</b> 失業率 = 失業人數 ÷ 勞動力 × 100%</p>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>年度</th>
                <th>失業率 (%)</th>
                <th>重大事件或影響因素</th>
              </tr>
            </thead>
            <tbody id="summary-rows"><!-- 由 JS 動態填入 --></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 第二頁：堆疊長條圖 -->
    <section class="chart-section page" id="page2">
      <div class="chart-canvas">
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-description">
        <h3>台灣勞動市場總體結構變化</h3>
        <p>就業與失業人數的組合反映勞動力規模；人口結構變化未必等比例轉化為就業。</p>
        <ul>
          <li>企業缺工？</li>
          <li>市場缺好工？</li>
          <li>人才與職缺是否「對不上」？</li>
        </ul>
      </div>
    </section>

    <!-- 第三頁：雙折線圖 -->
    <section class="chart-section page" id="page3">
      <div class="chart-canvas">
        <canvas id="dualLineChart"></canvas>
      </div>
      <div class="chart-description">
        <h3>參與了，卻沒被雇用？</h3>
        <p>將勞動力參與率與「就業人口占 15 歲以上人口」並列，觀察投入與被雇用的落差。</p>
        <ul>
          <li>長期待業、放棄求職者</li>
          <li>家務負擔下未能參與的女性</li>
          <li>非正式經濟中的未統計人口</li>
        </ul>
        <p>📌 勞動力參與率 =（在職＋失業）÷ 15 歲以上人口 × 100%</p>
      </div>
    </section>

    <div class="nav-buttons">
      <button onclick="changePage(-1)">上一頁</button>
      <div class="page-indicator">第 <span id="pageNum">1</span> / 3 頁</div>
      <button onclick="changePage(1)">下一頁</button>
    </div>
  </main>

  <footer class="footer">
    📩 聯絡我們 Taron_Lin｜<a href="#" onclick="openGmail()">blue8841269@gmail.com</a>
  </footer>

  <script>
    /* ===== 切頁狀態 ===== */
    const pages = document.querySelectorAll('.page');
    let currentPage = 0;
    let chartData = null;
    let lineChartInstance = null, barChartInstance = null, dualLineChartInstance = null;

    /* ===== 工具：資料正規化 ===== */
    function toNumberArray(arr) {
      return (arr || []).map(v => {
        if (typeof v === 'number') return v;
        if (v == null) return NaN;
        const n = parseFloat(String(v).replace(/[,%\s]/g, '').replace(/,/g, ''));
        return Number.isFinite(n) ? n : NaN;
      });
    }
    function toPercentString(value) {
      if (value == null) return '';
      if (typeof value !== 'number') value = parseFloat(String(value).replace(/[,%\s]/g, '').replace(/,/g, ''));
      if (!Number.isFinite(value)) return '';
      const isRatio = value > 0 && value <= 1;  // 0~1 視為比例
      const pct = isRatio ? (value * 100) : value;
      return pct.toFixed(1);
    }

    /* ===== 年份寬鬆匹配 ===== */
    function normalizeYearLabel(label) {
      if (label == null) return null;
      const s = String(label).trim();
      const minguo = s.match(/民國\s*([0-9]{1,3})\s*年?/);
      if (minguo) { const y = parseInt(minguo[1],10); if (Number.isFinite(y)) return 1911 + y; }
      const western = s.match(/([12][0-9]{3})/);
      if (western) { const y = parseInt(western[1],10); if (Number.isFinite(y)) return y; }
      if (!isNaN(Number(s))) { const y = Number(s); if (Number.isInteger(y) && y >= 1900 && y <= 2100) return y; }
      return null;
    }
    function buildYearIndexMap(labels) {
      const map = new Map();
      (labels || []).forEach((lab, i) => { const y = normalizeYearLabel(lab); if (y != null && !map.has(y)) map.set(y, i); });
      return map;
    }
    function getRateByYear(year, yearIndexMap) {
      const idx = yearIndexMap.get(year);
      if (idx == null) return null;
      const arr = chartData?.line_chart_data?.datasets?.[0]?.data || [];
      const raw = arr[idx];
      if (raw == null) return null;
      const n = parseFloat(String(raw).replace(/[,%\s]/g, '').replace(/,/g, ''));
      return Number.isFinite(n) ? n : null;
    }

    /* ===== 表格（單一定義，含 safeNote） ===== */
    function tableRowHTML(periodText, rateValue, note) {
      const rate = rateValue === '' ? '' : toPercentString(rateValue);
      const safeNote = (note == null || String(note).trim() === '') ? '—' : note;
      return `<tr>
        <td data-label="年度"><b>${periodText}</b></td>
        <td data-label="失業率 (%)">${rate}</td>
        <td data-label="重大事件或影響因素">${safeNote}</td>
      </tr>`;
    }

    function renderSummaryTableFromJSON(yearIndexMap) {
      const tbody = document.getElementById('summary-rows');
      if (!tbody) return false;
      const table = chartData?.summary_table;
      if (!Array.isArray(table) || table.length === 0) return false;

      tbody.innerHTML = table.map(row => {
        const periodText = row.period ??
                           (row.year != null ? String(row.year) :
                           (row.start != null && row.end != null ? `${row.start}–${row.end}` : '—'));
        let rateValue = row.rate;
        if (rateValue == null) {
          const y = row.year ?? row.start ?? null;
          const v = y != null ? getRateByYear(y, yearIndexMap) : null;
          rateValue = v ?? '';
        }
        return tableRowHTML(periodText, rateValue, row.note);
      }).join('');
      return true;
    }

    function renderSummaryTableAuto(yearIndexMap) {
      const tbody = document.getElementById('summary-rows');
      if (!tbody) return;

      const L = chartData?.line_chart_data?.labels || [];
      if (L.length === 0) { tbody.innerHTML = '<tr><td colspan="3">（沒有可用的年份資料）</td></tr>'; return; }

      function rowForRangeFlexible(start, end, note) {
        const hasStart = yearIndexMap.has(start);
        const hasEnd   = yearIndexMap.has(end);
        if (!hasStart && !hasEnd) return '';
        const yearForRate = hasStart ? start : (hasEnd ? end : null);
        const v = yearForRate != null ? getRateByYear(yearForRate, yearIndexMap) : null;
        const periodText = (start != null && end != null) ? `${start}–${end}` :
                           (start ?? end ?? '—');
        return tableRowHTML(periodText, v ?? '', note);
      }

      const lastLab = L[L.length - 1];
      const lastYear = normalizeYearLabel(lastLab);
      const lastVal = lastYear != null ? getRateByYear(lastYear, yearIndexMap) : null;

      const rows = [
        rowForRangeFlexible(1997, 1999, '亞洲金融風暴衝擊外銷與製造業，失業率上升。'),
        rowForRangeFlexible(2001, 2002, '網路泡沫破裂、全球景氣趨緩。'),
        rowForRangeFlexible(2008, 2009, '全球金融海嘯；政府推振興方案。'),
        rowForRangeFlexible(2020, 2022, 'COVID-19 衝擊接觸型服務業，失業率波動。'),
        (lastYear != null ? tableRowHTML(String(lastYear), lastVal ?? '', '疫後復甦，總體失業率回穩；隱性失業與就業品質仍受關注。') : '')
      ].filter(Boolean);

      if (rows.length === 0) {
        const firstYear = normalizeYearLabel(L[0]);
        const firstVal  = firstYear != null ? getRateByYear(firstYear, yearIndexMap) : null;
        rows.push(
          tableRowHTML(String(firstYear ?? L[0]), firstVal ?? '', '起始年度樣本。'),
          tableRowHTML(String(lastYear  ?? lastLab), lastVal ?? '',  '最新年度樣本。')
        );
      }

      tbody.innerHTML = rows.join('');
    }

    function buildSummaryTableWithMap() {
      const labels = chartData?.line_chart_data?.labels || [];
      const yearIndexMap = buildYearIndexMap(labels);
      const ok = renderSummaryTableFromJSON(yearIndexMap);
      if (!ok) renderSummaryTableAuto(yearIndexMap);
    }

    /* ===== Chart.js：切頁安全銷毀/重建 ===== */
    function destroyChart(instance, canvasId) {
      if (instance) instance.destroy();
      const el = document.getElementById(canvasId);
      if (el) { el.width = el.height = undefined; }
    }

    function showPage(index) {
      if (index !== 0) { destroyChart(lineChartInstance, 'lineChart'); lineChartInstance = null; }
      if (index !== 1) { destroyChart(barChartInstance, 'barChart'); barChartInstance = null; }
      if (index !== 2) { destroyChart(dualLineChartInstance, 'dualLineChart'); dualLineChartInstance = null; }

      pages.forEach((p, i) => p.classList.toggle('active', i === index));
      document.getElementById('pageNum').textContent = index + 1;
      currentPage = index;

      if (!chartData) return;
      requestAnimationFrame(() => {
        switch (index) {
          case 0: initLineChart(); break;
          case 1: initBarChart(); break;
          case 2: initDualLineChart(); break;
        }
      });
    }
    function changePage(delta) {
      currentPage = (currentPage + delta + pages.length) % pages.length;
      showPage(currentPage);
    }

    /* 折線圖：自動偵測 0–1 比例或百分比 */
    function initLineChart() {
      if (lineChartInstance) return;
      const labels = chartData.line_chart_data.labels;
      const raw = chartData.line_chart_data.datasets[0].data;
      const series = toNumberArray(raw);

      const valid = series.filter(v => Number.isFinite(v));
      const ratioLike = valid.length ? (valid.filter(v => v <= 1).length / valid.length > 0.6) : false;
      const scaled = ratioLike ? series.map(v => v * 100) : series.slice(); // 轉成百分比刻度
      const yMax = Math.ceil((Math.max(...scaled.filter(Number.isFinite)) || 10) * 1.15);
      const yMin = Math.max(0, Math.floor((Math.min(...scaled.filter(Number.isFinite)) || 0) * 0.9));

      lineChartInstance = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: { labels, datasets: [{
          label: '失業率', data: scaled,
          borderColor: '#1a3f5f', backgroundColor: 'rgba(26,63,95,0.15)',
          borderWidth: 2, pointRadius: 0, fill: true, tension: 0.2
        }]},
        options: {
          responsive: true, maintainAspectRatio: false, layout: { padding: 10 },
          plugins: { legend: { display: false } },
          scales: {
            y: {
              min: yMin, max: yMax,
              title: { display: true, text: '失業率 (%)', font: { size: 12 } },
              ticks: { callback: v => v + '%', font: { size: 10 } }
            },
            x: { title: { display: true, text: '年份', font: { size: 12 } },
                 ticks: { autoSkip: false, maxRotation: 45, font: { size: 10 } } }
          }
        }
      });
      lineChartInstance.resize();
    }

    /* 堆疊長條圖：自動尺度 */
    function initBarChart() {
      if (barChartInstance) return;
      const labels = chartData.bar_chart_data.labels;
      const emp = toNumberArray(chartData.bar_chart_data.datasets[0].data);
      const unemp = toNumberArray(chartData.bar_chart_data.datasets[1].data);

      const all = [...emp, ...unemp].filter(Number.isFinite);
      const min = Math.min(...all);
      const max = Math.max(...all);
      const pad = Math.max(50, Math.round((max - min) * 0.08)); // 留 8% 邊界
      const yMin = Math.max(0, min - pad);
      const yMax = max + pad;

      barChartInstance = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: { labels, datasets: [
          { label: '就業人數', data: emp,  backgroundColor: '#114b87', stack: 'stack1' },
          { label: '失業人數', data: unemp, backgroundColor: '#f37021', stack: 'stack1' }
        ]},
        options: {
          responsive: true, maintainAspectRatio: false, layout: { padding: 10 },
          plugins: { legend: { position: 'top', labels: { font: { size: 12 } } } },
          scales: {
            x: { stacked: true, title: { display: true, text: '年份', font: { size: 12 } },
                 ticks: { autoSkip: false, maxRotation: 45, font: { size: 10 } } },
            y: { stacked: true, min: yMin, max: yMax, title: { display: true, text: '人數（千人）', font: { size: 12 } },
                 ticks: { font: { size: 10 } } }
          }
        }
      });
      barChartInstance.resize();
    }

    /* 雙折線圖 */
    function initDualLineChart() {
      if (dualLineChartInstance) return;
      const labels = chartData.dual_line_chart_data.labels;
      const p1 = toNumberArray(chartData.dual_line_chart_data.datasets[0].data);
      const p2 = toNumberArray(chartData.dual_line_chart_data.datasets[1].data);

      dualLineChartInstance = new Chart(document.getElementById('dualLineChart'), {
        type: 'line',
        data: { labels, datasets: [
          { label: '勞動力參與率(%)', data: p1, borderColor: '#114b87', backgroundColor: '#114b87', borderWidth: 4, fill: false, tension: 0.2, pointRadius: 0 },
          { label: '就業人口占15歲以上民間人口(%)', data: p2, borderColor: '#f37021', backgroundColor: '#f37021', borderWidth: 4, fill: false, tension: 0.2, pointRadius: 0 }
        ]},
        options: {
          responsive: true, maintainAspectRatio: false, layout: { padding: 10 },
          plugins: { legend: { position: 'top', labels: { font: { size: 12 } } } },
          scales: {
            y: { suggestedMin: 53, suggestedMax: 62, title: { display: true, text: '百分比 (%)', font: { size: 12 } },
                 ticks: { callback: v => v + '%', font: { size: 10 } } },
            x: { title: { display: true, text: '年份', font: { size: 12 } },
                 ticks: { autoSkip: false, maxRotation: 45, font: { size: 10 } } }
          }
        }
      });
      dualLineChartInstance.resize();
    }

    function openGmail() {
      const email = "blue8841269@gmail.com";
      const subject = encodeURIComponent("詢問：失業趨勢分析");
      const body = encodeURIComponent("您好，我想了解台灣失業率資料的更多細節...");
      window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${subject}&body=${body}`, '_blank');
    }

    /* ===== 啟動 ===== */
    fetch("chart_data_embed.json?v=" + Date.now())
      .then(res => res.json())
      .then(data => {
        chartData = data;
        showPage(currentPage);       // 顯示第 1 頁並建圖
        buildSummaryTableWithMap();  // 生成表格（JSON 優先，否則自動）

        window.addEventListener('resize', () => {
          lineChartInstance?.resize();
          barChartInstance?.resize();
          dualLineChartInstance?.resize();
        });
      })
      .catch(err => console.error("❌ 無法載入 chart_data_embed.json", err));

    // 導覽自動高亮目前頁
    document.querySelectorAll('nav a').forEach(a => {
      const href = a.getAttribute('href');
      const current = location.pathname.split('/').pop() || 'index.html';
      if (href === current) a.classList.add('active');
    });
  </script>
</body>
</html>
